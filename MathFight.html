
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Math Fight</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --player-color-primary: #0d6efd;
            --player-color-secondary: #ffc107;
            --opponent-color-primary: #dc3545;
            --opponent-color-secondary: #343a40;
            
            --background-dark: #100f1c;
            --background-light: #1f1d36;
            --ring-floor: #3f3351;
            --ropes-color: #e94560;
            --ropes-posts: #8675a9;

            --text-light: #f0f0f0;
            --text-dark: #1e1e1e;
            --accent-gold: #ffd700;
            --accent-cyan: #00bcd4;
            
            --stamina-bar-color: #20c997;
            --stamina-bar-bg: #444;
            --stamina-bar-damage: #ff4757;


            
            --timer-bar-color: var(--accent-cyan);
            --timer-bar-bg: #444;

            --btn-bg: #4a47a3;
            --btn-hover-bg: #615dcf;
            --btn-border: #c0c0c0;
            --btn-correct-bg: #28a745;
            --btn-incorrect-bg: #dc3545;

            --font-display: 'Bangers', cursive;
            --font-body: 'Montserrat', sans-serif;
        }

        /* --- KEYFRAMES --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes popIn {
          0%   { transform: scale(0.5); opacity: 0; }
          70%  { transform: scale(1.2); opacity: 1; }
          100% { transform: scale(1);   opacity: 1; }
        }
        @keyframes popInCentered {
          0%   { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
          70%  { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1);   opacity: 1; }
        }
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10%, 50%, 90% { transform: translate(-4px, 2px); }
            30%, 70% { transform: translate(4px, -2px); }
        }
        @keyframes takeDamage {
            0%, 100% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(2.5) contrast(2); transform: scale(1.05); }
        }
        @keyframes attackLunge {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); }
            50% { transform: translate(120px, -30px) scale(1.2) rotate(15deg); z-index: 10; }
            100% { transform: translate(0, 0) scale(1) rotate(0deg); z-index: 1; }
        }
        @keyframes opponentAttackLunge {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); }
            50% { transform: translate(-120px, -30px) scale(1.2) rotate(-15deg); z-index: 10; }
            100% { transform: translate(0, 0) scale(1) rotate(0deg); z-index: 1; }
        }
        @keyframes qteShrink {
            from { transform: translate(-50%, -50%) scale(2.5); opacity: 0.9; }
            to { transform: translate(-50%, -50%) scale(0.2); opacity: 1; }
        }


        @keyframes textFadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes comboPop {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes smokeDrift {
            0% { opacity: 0; transform: scale(0.5) rotate(0deg); }
            20% { opacity: 0.7; }
            80% { opacity: 0.7; }
            100% { opacity: 0; transform: scale(2) rotate(45deg); }
        }
        @keyframes pi√±ataBurst {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        @keyframes incorrectoPop {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            20% { transform: translate(-50%, -50%); opacity: 1; }
            80% { transform: translate(-50%, -50%); opacity: 1; }
            100% { transform: translate(-50%, -150%); opacity: 0; }
        }

        /* --- GENERAL STYLES --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-body);
            background-color: var(--background-dark);
            color: var(--text-light);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(ellipse at 50% 70%, var(--background-light) 30%, var(--background-dark) 80%);
            isolation: isolate;
        }
        
        .arena-background { position: absolute; inset: 0; overflow: hidden; }
        .arena-background::before { content: ''; position: absolute; inset: 0; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%23000" fill-opacity="0.1"%3E%3Crect x="50" width="50" height="50"/%3E%3Crect y="50" width="50" height="50"/%3E%3C/g%3E%3C/svg%3E'); opacity: 0.3; transform: scale(1.5); }
        .arena-background::after { content: ''; position: absolute; bottom: 0; left: -20%; width: 140%; height: 50%; background-color: var(--ring-floor); border-top: 10px solid var(--ropes-posts); border-radius: 50% / 20px; }
        .ring-ropes { position: absolute; bottom: 25%; left: 0; width: 100%; height: 2px; background: var(--ropes-color); opacity: 0.7; box-shadow: 0 -15px 0 var(--ropes-color); }

        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center; transition: opacity 0.4s ease-in-out, z-index 0.4s; z-index: 10; background: rgba(0,0,0,0.1); }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        h1, h2, h3 { font-family: var(--font-display); letter-spacing: 2px; text-transform: uppercase; }
        h1 { font-size: clamp(3rem, 10vw, 6rem); color: var(--accent-gold); text-shadow: 5px 5px 0px var(--ropes-color), -2px -2px 0px #000; margin-bottom: 25px; line-height: 1; }
        h2 { font-size: clamp(1.8rem, 5vw, 2.5rem); color: var(--accent-cyan); text-shadow: 3px 3px 0px #000; }

        .button { font-family: var(--font-display); background-color: var(--btn-bg); color: var(--text-light); border: 2px solid var(--btn-border); border-bottom: 6px solid #2c2a64; padding: 15px 30px; font-size: clamp(1.2rem, 4vw, 1.8rem); letter-spacing: 1px; cursor: pointer; border-radius: 12px; transition: all 0.1s ease-out; margin: 10px; text-shadow: 2px 2px 2px #000; text-transform: uppercase; }
        .button:hover, .button:focus { background-color: var(--btn-hover-bg); transform: translateY(-2px); border-bottom-width: 8px; outline: 2px solid var(--accent-gold); }
        .button:active { transform: translateY(2px); border-bottom-width: 4px; }

        /* --- LOCKER ROOM --- */
        #locker-room-screen {
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 10px;
            padding-bottom: 20px;
            gap: 10px;
        }
        #locker-room-screen h1 { margin-bottom: 15px; }
        #locker-room-screen .content-box { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); padding: 15px; border-radius: 15px; margin-bottom: 0; width: 90%; max-width: 700px; border: 2px solid var(--ropes-posts); }
        .swatches-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .swatch-group { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; transition: transform 0.2s; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; font-family: sans-serif; font-size: 24px; }
        .swatch:hover, .swatch:focus { transform: scale(1.1); outline: 2px solid var(--accent-gold); }
        .swatch.selected { border-color: var(--accent-gold); transform: scale(1.2); }
        .locker-room-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0;
        }

        /* --- GAME SCREEN --- */
        #game-screen { background: transparent; justify-content: space-between; padding: 10px; gap: 10px; }
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; box-sizing: border-box; gap: 10px; }
        .player-info, .opponent-info { display: flex; align-items: center; width: 40%; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 15px; border: 2px solid var(--ropes-posts); }
        .opponent-info { flex-direction: row-reverse; }
        .luchador-portrait { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--text-light); margin: 0 10px; font-family: sans-serif; font-size: 30px; display: flex; justify-content: center; align-items: center; background-color: #333; }
        #player-portrait { background-color: var(--player-color-primary); }
        #opponent-portrait { background-color: var(--opponent-color-primary); }
        .info-details { flex-grow: 1; text-align: left; }
        .opponent-info .info-details { text-align: right; }
        .info-details h3 { margin: 0 0 5px 0; font-size: 1rem; color: var(--text-light); text-shadow: 2px 2px 2px #000; }
        .stamina-bar-container { width: 100%; height: 20px; background-color: var(--stamina-bar-bg); border-radius: 10px; overflow: hidden; border: 2px solid #222; padding: 2px; }
        .stamina-bar { width: 100%; height: 100%; background: linear-gradient(to right, var(--stamina-bar-color), #66ffc2); border-radius: 6px; transition: width 0.3s ease-out; }
        .stamina-bar.damaged { background-color: var(--stamina-bar-damage); transition: background-color 0.1s, width 0.3s; }
        .center-hud { text-align: center; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 15px; border: 2px solid var(--ropes-posts); }
        #score { font-size: 2rem; font-weight: 700; color: var(--accent-gold); }
        #combo-meter { font-size: 1.5rem; color: var(--accent-cyan); font-family: var(--font-display); transition: transform 0.1s ease-out; height: 25px;}
        .timer-container { width: 120px; height: 10px; background-color: var(--timer-bar-bg); border-radius: 5px; margin: 5px auto 0; overflow: hidden; border: 1px solid #000; }
        .timer-bar { width: 100%; height: 100%; background-color: var(--timer-bar-color); border-radius: 5px; }

        .center-stage { width: 100%; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .ring-area { display: flex; justify-content: space-around; align-items: flex-end; width: 100%; max-width: 600px; height: 180px; position: relative; }
        .luchador { width: 120px; height: 150px; position: relative; transition: transform 0.3s ease; }
        .luchador-body { width: 70px; height: 90px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 35px 35px 10px 10px; }
        .luchador-mask { width: 80px; height: 80px; border-radius: 50%; position: absolute; top: 0; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .luchador-mask .mask-icon { font-family: sans-serif; font-size: 40px; transform: translateY(2px); }
        #player-luchador .luchador-mask { background-color: var(--player-color-primary); }
        #player-luchador .luchador-body { background-color: var(--player-color-secondary); }
        
        #question-box { background: rgba(0,0,0,0.7); padding: 20px; border-radius: 15px; font-size: clamp(1.3rem, 4vw, 2rem); font-weight: 600; margin-top: 20px; border: 3px solid var(--accent-cyan); box-shadow: 0 0 15px rgba(0, 188, 212, 0.5); min-height: 80px; display: flex; justify-content: center; align-items: center; width: 95%; max-width: 900px; transition: opacity 0.5s, filter 0.5s; }
        .bottom-bar { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #answer-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; }
        .answer-button { min-width: 220px; padding: 20px; font-size: 1.5rem; }
        .answer-button.correct { background-color: var(--btn-correct-bg); border-color: #fff; animation: popIn 0.3s; }
        .answer-button.incorrect { background-color: var(--btn-incorrect-bg); border-color: #555; opacity: 0.6; }


        
        /* --- EFFECTS & FEEDBACK --- */
        #qte-container { position: absolute; z-index: 100; }
        #qte-target { width: 120px; height: 120px; border: 5px dashed var(--ropes-color); border-radius: 50%; cursor: pointer; animation: popIn 0.3s; }
        #qte-circle { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; background-color: rgba(255, 215, 0, 0.7); border-radius: 50%; animation: qteShrink 0.6s linear forwards; }
        .feedback-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* QA FEEDBACK FIX: Proper centering to prevent jitter */
            font-family: var(--font-display);
            text-shadow: 3px 3px 0px #000;
            z-index: 101;
            pointer-events: none;
        }
        #qte-result {
          font-size: 3rem;
          animation: popInCentered 0.5s, textFadeOut 0.5s 0.5s forwards;
        }
        #incorrecto-feedback { font-size: 2.5rem; color: var(--ropes-color); animation: incorrectoPop 1.5s ease-out forwards; }

        .smoke-overlay { position: absolute; width: 150px; height: 150px; background: radial-gradient(circle, rgba(200,200,200,0.6) 0%, rgba(200,200,200,0) 70%); border-radius: 50%; pointer-events: none; z-index: 50; animation: smokeDrift 3s ease-out forwards; }
        .pi√±ata-burst { position: absolute; width: 20px; height: 20px; background-color: var(--accent-gold); border-radius: 50%; pointer-events: none; z-index: 100; animation: pi√±ataBurst 0.5s ease-out forwards; }



        /* --- MODALS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--background-light); padding: 30px; border-radius: 20px; border: 4px solid var(--ropes-color); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; transform: scale(0.8); transition: transform 0.3s ease-in-out; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; }
        .modal-content ul { list-style: none; padding: 0; }
        .modal-content li { background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 10px; border-radius: 5px; font-weight: 600; border-left: 5px solid var(--accent-cyan); }
        #special-choice-modal .button { display: block; width: 80%; margin: 15px auto; }
        .achievement-list li { border-left-color: var(--accent-gold); }
        .bracket-item { font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .bracket-item.defeated { text-decoration: line-through; color: #888; }
        .bracket-item.current::before { content: '‚ñ∂'; color: var(--accent-gold); margin-right: 10px; }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            .player-info, .opponent-info { width: 48%; }
            .center-hud { order: 0; }
            .top-bar { flex-wrap: wrap; justify-content: center; }
            #question-box { font-size: 1.2rem; }
            .answer-button { min-width: 180px; font-size: 1.2rem; padding: 15px; }
            .ring-area { height: 150px; }
            .luchador { width: 100px; height: 120px; }
            @keyframes attackLunge { 50% { transform: translate(80px, -20px) scale(1.15) rotate(15deg); z-index: 10; } }
            @keyframes opponentAttackLunge { 50% { transform: translate(-80px, -20px) scale(1.15) rotate(-15deg); z-index: 10; } }
        }
        
        /* --- HUMAN/QA FEEDBACK IMPLEMENTATION for MOBILE --- */
        @media (max-width: 480px) {
            .top-bar { 
                flex-direction: row; 
                flex-wrap: wrap;
                gap: 8px; 
                padding-top: 60px; /* HUMAN FEEDBACK FIX: Make space for shorter absolute positioned scoreboard */
                position: relative;
            }
            .player-info, .opponent-info { width: 48%; }
            .center-hud { 
                position: absolute; 
                top: 10px; 
                left: 50%; 
                transform: translateX(-50%); 
                width: 95%; /* HUMAN FEEDBACK FIX: Wider scoreboard */
                z-index: 20;
                 /* HUMAN FEEDBACK FIX: Horizontal layout for score and timer */
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px 10px;
            }
            #score {
                font-size: 1.6rem;
            }
            #combo-meter {
                font-size: 1rem;
                height: auto;
                flex-grow: 1;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
            }
            .timer-container {
                width: 100px;
                margin: 0;
            }
            #question-box { 
                padding: 12px;
                min-height: 70px;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            #answer-buttons { 
                flex-direction: column; 
                align-items: center; 
                width: 100%;
                gap: 8px;
            }
            .answer-button { 
                width: 90%; 
                padding: 12px;
                margin: 0;
            }

        }
    </style>
</head>
<body>

    <div class="game-container">
        <div class="arena-background">
            <div class="ring-ropes"></div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h1>Math Fight</h1>
            <p style="font-size: 1.2rem; margin-top: 0; margin-bottom: 30px; font-weight: 600;">The Ultimate Math Showdown!</p>
            <div id="start-button" class="button" tabindex="0">Start Tournament</div>
        </div>

        <!-- Locker Room Screen -->
        <div id="locker-room-screen" class="screen hidden">
            <h1>Locker Room</h1>
            <div class="content-box">
                <h2>Customize Your Luchador</h2>
                <div class="swatches-container">
                    <div class="swatch-group"><span style="margin-right: 10px;">Mask:</span><div id="mask-swatches" class="swatch-group"></div></div>
                    <div class="swatch-group"><span style="margin-right: 10px;">Color 1:</span><div id="primary-swatches" class="swatch-group"></div></div>
                    <div class="swatch-group"><span style="margin-right: 10px;">Color 2:</span><div id="secondary-swatches" class="swatch-group"></div></div>
                </div>
            </div>
            <div class="content-box">
                <h2>Next Opponent: <span id="next-opponent-name" style="color: var(--ropes-color);"></span></h2>
                <p style="font-weight: 600;">Specialty: <span id="next-opponent-specialty" style="color: #fff;"></span></p>
            </div>
            <div class="locker-room-actions">
                <div id="continue-to-match-button" class="button" tabindex="0">Fight!</div>
                <div id="bracket-button" class="button" tabindex="0">Tournament Bracket</div>
                <div id="stats-button" class="button" tabindex="0">Career Stats</div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="top-bar">
                <div class="player-info">
                    <div id="player-portrait" class="luchador-portrait"></div>
                    <div class="info-details">
                        <h3>The Player</h3>
                        <div class="stamina-bar-container"><div id="player-stamina" class="stamina-bar"></div></div>
                    </div>
                </div>
                <div class="center-hud">
                    <div id="score">0</div>
                    <div id="combo-meter"></div>
                    <div class="timer-container"><div id="timer-bar" class="timer-bar"></div></div>
                </div>
                <div class="opponent-info">
                    <div id="opponent-portrait" class="luchador-portrait"></div>
                    <div class="info-details">
                        <h3 id="opponent-name">Se√±or Presente</h3>
                        <div class="stamina-bar-container"><div id="opponent-stamina" class="stamina-bar"></div></div>
                    </div>
                </div>
            </div>

            <div class="center-stage">
                <div class="ring-area">
                    <div id="player-luchador" class="luchador"><div class="luchador-body"></div><div class="luchador-mask"><span class="mask-icon"></span></div></div>
                    <div id="opponent-luchador" class="luchador"><div class="luchador-body"></div><div class="luchador-mask"><span class="mask-icon"></span></div></div>
                </div>
                <div id="question-box">Loading question...</div>
            </div>

            <div class="bottom-bar">
                <div id="answer-buttons"></div>
            </div>
        </div>



        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen hidden">
            <h1 id="game-over-title"></h1>
            <p id="game-over-message" style="font-size: 1.5rem; font-weight: 600;"></p>
            <div id="rematch-button" class="button" tabindex="0">Rematch</div>
            <div id="next-match-button" class="button" tabindex="0">Next Opponent</div>
            <div id="endless-rumble-button" class="button" tabindex="0">Endless Rumble</div>
            <div id="main-menu-button" class="button" tabindex="0">Main Menu</div>
        </div>
        
        <!-- Effects Containers -->
        <div id="qte-container" class="hidden"><div id="qte-target"><div id="qte-circle"></div></div></div>
        <div id="effects-container"></div> <!-- For smoke, bursts, feedback text etc. -->

        <!-- Modals -->
        <div id="bracket-modal" class="modal"><div class="modal-content"><h2>Tournament Bracket</h2><ul id="bracket-list"></ul><div id="close-bracket-button" class="button" tabindex="0">Close</div></div></div>

        <div id="stats-modal" class="modal"><div class="modal-content"><h2>Career Stats</h2><p>Wins: <span id="stats-wins">0</span></p><p>Perfect Rounds: <span id="stats-perfect">0</span></p><p>Highest Combo: <span id="stats-combo">0</span></p><h3>Champion Titles</h3><ul id="achievement-list" class="achievement-list"><li>None yet!</li></ul><div id="close-stats-button" class="button" tabindex="0">Close</div></div></div>


    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const gameContainer = document.querySelector('.game-container');
            const screens = {
                start: document.getElementById('start-screen'),
                lockerRoom: document.getElementById('locker-room-screen'),
                game: document.getElementById('game-screen'),
                gameOver: document.getElementById('game-over-screen'),
            };

            const ui = {
                score: document.getElementById('score'),
                comboMeter: document.getElementById('combo-meter'),
                playerStamina: document.getElementById('player-stamina'),
                opponentStamina: document.getElementById('opponent-stamina'),
                questionBox: document.getElementById('question-box'),
                answerButtons: document.getElementById('answer-buttons'),
                timerBar: document.getElementById('timer-bar'),
                playerLuchador: document.getElementById('player-luchador'),
                opponentLuchador: document.getElementById('opponent-luchador'),
                playerPortrait: document.getElementById('player-portrait'),
                opponentPortrait: document.getElementById('opponent-portrait'),
                opponentName: document.getElementById('opponent-name'),
                qteContainer: document.getElementById('qte-container'),
                qteTarget: document.getElementById('qte-target'),
                effectsContainer: document.getElementById('effects-container'),
                gameOverTitle: document.getElementById('game-over-title'),
                gameOverMessage: document.getElementById('game-over-message'),
                rematchButton: document.getElementById('rematch-button'),
                nextMatchButton: document.getElementById('next-match-button'),
                endlessRumbleButton: document.getElementById('endless-rumble-button'),
                mainMenuButton: document.getElementById('main-menu-button'),
            };
            
            const modals = {
                bracket: document.getElementById('bracket-modal'),
                stats: document.getElementById('stats-modal'),
            };

            // --- GAME DATA ---
            const opponents = [
                { id: 0, name: "The Calculator", health: 100, specialty: "Fractions & decimals", mechanic: null, mask: 'üòæ', color1: '#c0392b', color2: '#f1c40f' },
                { id: 1, name: "Digit Destroyer", health: 120, specialty: "Multi-digit operations", mechanic: 'shuffle', mask: 'ü§°', color1: '#8e44ad', color2: '#2ecc71' },
                { id: 2, name: "Equation Master", health: 150, specialty: "Linear equations", mechanic: 'fade', mask: 'üëΩ', color1: '#d35400', color2: '#bdc3c7' },
                { id: 3, name: "Root Crusher", health: 180, specialty: "Square roots & powers", mechanic: 'smokescreen', mask: 'üíÄ', color1: '#e83e8c', color2: '#ffffff' },
                { id: 4, name: "Formula King", health: 220, specialty: "Advanced operations", mechanic: 'shuffle', mask: 'üëë', color1: '#6f42c1', color2: '#ffd700' },
            ];

            const questionsByLevel = {
              0: [  // Fractions & decimals (Level 1)
                { id: '0a', sentence: "1/2 + 1/4 = ?",                    options: ["3/4","2/3","5/6"],                  correct: 0 },
                { id: '0b', sentence: "0.5 + 0.3 = ?",                    options: ["0.8","0.7","0.9"],                  correct: 0 },
                { id: '0c', sentence: "3/4 - 1/4 = ?",                    options: ["1/2","1/3","2/3"],                  correct: 0 },
                { id: '0d', sentence: "1.2 - 0.7 = ?",                    options: ["0.5","0.4","0.6"],                  correct: 0 },
                { id: '0e', sentence: "2/3 √ó 3/4 = ?",                    options: ["1/2","2/5","3/5"],                  correct: 0 },
                { id: '0f', sentence: "0.6 √ó 0.5 = ?",                    options: ["0.3","0.25","0.35"],                correct: 0 },
                { id: '0g', sentence: "1/3 + 1/6 = ?",                    options: ["1/2","2/5","3/7"],                  correct: 0 },
                { id: '0h', sentence: "2.5 + 1.75 = ?",                   options: ["4.25","4.5","3.75"],                correct: 0 },
                { id: '0i', sentence: "5/6 - 1/3 = ?",                    options: ["1/2","1/4","2/3"],                  correct: 0 },
                { id: '0j', sentence: "3.8 - 1.9 = ?",                    options: ["1.9","2.1","1.7"],                  correct: 0 },
                { id: '0k', sentence: "1/4 √ó 2/3 = ?",                    options: ["1/6","1/8","1/4"],                  correct: 0 },
                { id: '0l', sentence: "0.4 √ó 0.25 = ?",                   options: ["0.1","0.15","0.05"],                correct: 0 },
                { id: '0m', sentence: "2/5 + 1/10 = ?",                   options: ["1/2","3/7","4/9"],                  correct: 0 },
                { id: '0n', sentence: "4.6 + 2.85 = ?",                   options: ["7.45","7.25","7.65"],               correct: 0 },
                { id: '0o', sentence: "7/8 - 3/8 = ?",                    options: ["1/2","1/4","3/4"],                  correct: 0 },
                { id: '0p', sentence: "5.0 - 2.35 = ?",                   options: ["2.65","2.75","2.55"],               correct: 0 },
                { id: '0q', sentence: "3/5 √ó 1/2 = ?",                    options: ["3/10","2/7","1/3"],                 correct: 0 },
                { id: '0r', sentence: "0.8 √ó 0.4 = ?",                    options: ["0.32","0.28","0.36"],               correct: 0 },
                { id: '0s', sentence: "1/6 + 1/3 = ?",                    options: ["1/2","2/5","3/7"],                  correct: 0 },
                { id: '0t', sentence: "6.25 - 3.7 = ?",                   options: ["2.55","2.45","2.65"],               correct: 0 },
                { id: '0u', sentence: "3/8 + 1/8 = ?",                    options: ["1/2","3/8","5/8"],                  correct: 0 },
                { id: '0v', sentence: "0.9 - 0.4 = ?",                    options: ["0.5","0.6","0.4"],                  correct: 0 },
                { id: '0w', sentence: "1/5 √ó 2/3 = ?",                    options: ["2/15","1/8","3/15"],                correct: 0 },
                { id: '0x', sentence: "3.2 + 1.8 = ?",                    options: ["5.0","4.8","5.2"],                  correct: 0 },
                { id: '0y', sentence: "4/5 - 2/5 = ?",                    options: ["2/5","1/5","3/5"],                  correct: 0 },
                { id: '0z', sentence: "0.75 √ó 0.2 = ?",                   options: ["0.15","0.12","0.18"],               correct: 0 },
                { id: '0aa', sentence: "1/8 + 3/8 = ?",                   options: ["1/2","3/8","5/8"],                  correct: 0 },
                { id: '0bb', sentence: "7.3 - 2.8 = ?",                   options: ["4.5","4.3","4.7"],                  correct: 0 },
                { id: '0cc', sentence: "2/7 √ó 3/4 = ?",                   options: ["6/28","3/14","6/11"],               correct: 0 },
                { id: '0dd', sentence: "1.6 + 2.9 = ?",                   options: ["4.5","4.3","4.7"],                  correct: 0 },
                { id: '0ee', sentence: "9/10 - 3/10 = ?",                 options: ["3/5","6/10","4/5"],                 correct: 0 },
                { id: '0ff', sentence: "0.36 √ó 0.5 = ?",                  options: ["0.18","0.16","0.20"],               correct: 0 },
                { id: '0gg', sentence: "2/9 + 1/9 = ?",                   options: ["1/3","2/9","4/9"],                  correct: 0 },
                { id: '0hh', sentence: "8.7 - 3.2 = ?",                   options: ["5.5","5.3","5.7"],                  correct: 0 },
                { id: '0ii', sentence: "3/10 √ó 2/5 = ?",                  options: ["3/25","6/50","1/8"],                correct: 0 },
                { id: '0jj', sentence: "0.64 + 0.28 = ?",                 options: ["0.92","0.90","0.94"],               correct: 0 },
                { id: '0kk', sentence: "11/12 - 5/12 = ?",                options: ["1/2","6/12","7/12"],                correct: 0 },
                { id: '0ll', sentence: "1.25 √ó 0.4 = ?",                  options: ["0.5","0.45","0.55"],                correct: 0 },
                { id: '0mm', sentence: "1/7 + 2/7 = ?",                   options: ["3/7","1/7","4/7"],                  correct: 0 },
                { id: '0nn', sentence: "9.6 - 4.8 = ?",                   options: ["4.8","4.6","5.0"],                  correct: 0 }
              ],

              1: [  // Multi-digit operations (Level 2)
                { id: '1a', sentence: "23 + 17 = ?",                      options: ["40","42","38"],                     correct: 0 },
                { id: '1b', sentence: "156 - 89 = ?",                     options: ["67","69","65"],                     correct: 0 },
                { id: '1c', sentence: "37 √ó 8 = ?",                       options: ["296","294","298"],                  correct: 0 },
                { id: '1d', sentence: "448 √∑ 8 = ?",                      options: ["56","54","58"],                     correct: 0 },
                { id: '1e', sentence: "145 + 297 = ?",                    options: ["442","440","444"],                  correct: 0 },
                { id: '1f', sentence: "512 - 186 = ?",                    options: ["326","324","328"],                  correct: 0 },
                { id: '1g', sentence: "24 √ó 15 = ?",                      options: ["360","350","370"],                  correct: 0 },
                { id: '1h', sentence: "684 √∑ 12 = ?",                     options: ["57","55","59"],                     correct: 0 },
                { id: '1i', sentence: "278 + 394 = ?",                    options: ["672","670","674"],                  correct: 0 },
                { id: '1j', sentence: "803 - 467 = ?",                    options: ["336","334","338"],                  correct: 0 },
                { id: '1k', sentence: "43 √ó 19 = ?",                      options: ["817","815","819"],                  correct: 0 },
                { id: '1l', sentence: "896 √∑ 16 = ?",                     options: ["56","54","58"],                     correct: 0 },
                { id: '1m', sentence: "365 + 487 = ?",                    options: ["852","850","854"],                  correct: 0 },
                { id: '1n', sentence: "700 - 338 = ?",                    options: ["362","360","364"],                  correct: 0 },
                { id: '1o', sentence: "56 √ó 23 = ?",                      options: ["1288","1286","1290"],               correct: 0 },
                { id: '1p', sentence: "1104 √∑ 24 = ?",                    options: ["46","44","48"],                     correct: 0 },
                { id: '1q', sentence: "564 + 789 = ?",                    options: ["1353","1351","1355"],               correct: 0 },
                { id: '1r', sentence: "1000 - 743 = ?",                   options: ["257","255","259"],                  correct: 0 },
                { id: '1s', sentence: "72 √ó 14 = ?",                      options: ["1008","1006","1010"],               correct: 0 },
                { id: '1t', sentence: "1365 √∑ 15 = ?",                    options: ["91","89","93"],                     correct: 0 },
                { id: '1u', sentence: "89 + 76 = ?",                      options: ["165","163","167"],                  correct: 0 },
                { id: '1v', sentence: "234 - 147 = ?",                    options: ["87","85","89"],                     correct: 0 },
                { id: '1w', sentence: "29 √ó 7 = ?",                       options: ["203","201","205"],                  correct: 0 },
                { id: '1x', sentence: "576 √∑ 9 = ?",                      options: ["64","62","66"],                     correct: 0 },
                { id: '1y', sentence: "458 + 367 = ?",                    options: ["825","823","827"],                  correct: 0 },
                { id: '1z', sentence: "892 - 456 = ?",                    options: ["436","434","438"],                  correct: 0 },
                { id: '1aa', sentence: "38 √ó 17 = ?",                     options: ["646","644","648"],                  correct: 0 },
                { id: '1bb', sentence: "714 √∑ 21 = ?",                    options: ["34","32","36"],                     correct: 0 },
                { id: '1cc', sentence: "679 + 284 = ?",                   options: ["963","961","965"],                  correct: 0 },
                { id: '1dd', sentence: "750 - 389 = ?",                   options: ["361","359","363"],                  correct: 0 },
                { id: '1ee', sentence: "45 √ó 26 = ?",                     options: ["1170","1168","1172"],               correct: 0 },
                { id: '1ff', sentence: "952 √∑ 17 = ?",                    options: ["56","54","58"],                     correct: 0 },
                { id: '1gg', sentence: "327 + 596 = ?",                   options: ["923","921","925"],                  correct: 0 },
                { id: '1hh', sentence: "1200 - 847 = ?",                  options: ["353","351","355"],                  correct: 0 },
                { id: '1ii', sentence: "64 √ó 18 = ?",                     options: ["1152","1150","1154"],               correct: 0 },
                { id: '1jj', sentence: "1274 √∑ 22 = ?",                   options: ["58","56","60"],                     correct: 0 },
                { id: '1kk', sentence: "743 + 289 = ?",                   options: ["1032","1030","1034"],               correct: 0 },
                { id: '1ll', sentence: "865 - 478 = ?",                   options: ["387","385","389"],                  correct: 0 },
                { id: '1mm', sentence: "73 √ó 12 = ?",                     options: ["876","874","878"],                  correct: 0 },
                { id: '1nn', sentence: "1316 √∑ 28 = ?",                   options: ["47","45","49"],                     correct: 0 }
              ],

              2: [  // Linear equations (Level 3)
                { id: '2a', sentence: "2x + 5 = 15, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2b', sentence: "3x - 7 = 14, x = ?",               options: ["7","6","8"],                        correct: 0 },
                { id: '2c', sentence: "4x + 12 = 32, x = ?",              options: ["5","4","6"],                        correct: 0 },
                { id: '2d', sentence: "5x - 8 = 27, x = ?",               options: ["7","6","8"],                        correct: 0 },
                { id: '2e', sentence: "6x + 9 = 39, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2f', sentence: "2x - 11 = 5, x = ?",               options: ["8","7","9"],                        correct: 0 },
                { id: '2g', sentence: "7x + 4 = 25, x = ?",               options: ["3","2","4"],                        correct: 0 },
                { id: '2h', sentence: "3x - 15 = 0, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2i', sentence: "8x + 7 = 31, x = ?",               options: ["3","2","4"],                        correct: 0 },
                { id: '2j', sentence: "4x - 9 = 11, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2k', sentence: "9x + 6 = 33, x = ?",               options: ["3","2","4"],                        correct: 0 },
                { id: '2l', sentence: "5x - 12 = 18, x = ?",              options: ["6","5","7"],                        correct: 0 },
                { id: '2m', sentence: "2x + 17 = 29, x = ?",              options: ["6","5","7"],                        correct: 0 },
                { id: '2n', sentence: "6x - 4 = 26, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2o', sentence: "10x + 8 = 48, x = ?",              options: ["4","3","5"],                        correct: 0 },
                { id: '2p', sentence: "3x - 21 = 6, x = ?",               options: ["9","8","10"],                       correct: 0 },
                { id: '2q', sentence: "7x + 14 = 42, x = ?",              options: ["4","3","5"],                        correct: 0 },
                { id: '2r', sentence: "4x - 16 = 12, x = ?",              options: ["7","6","8"],                        correct: 0 },
                { id: '2s', sentence: "8x + 5 = 37, x = ?",               options: ["4","3","5"],                        correct: 0 },
                { id: '2t', sentence: "5x - 25 = 10, x = ?",              options: ["7","6","8"],                        correct: 0 },
                { id: '2u', sentence: "3x + 8 = 23, x = ?",               options: ["5","4","6"],                        correct: 0 },
                { id: '2v', sentence: "6x - 18 = 12, x = ?",              options: ["5","4","6"],                        correct: 0 },
                { id: '2w', sentence: "2x + 13 = 25, x = ?",              options: ["6","5","7"],                        correct: 0 },
                { id: '2x', sentence: "9x - 27 = 18, x = ?",              options: ["5","4","6"],                        correct: 0 },
                { id: '2y', sentence: "4x + 6 = 22, x = ?",               options: ["4","3","5"],                        correct: 0 },
                { id: '2z', sentence: "7x - 21 = 14, x = ?",              options: ["5","4","6"],                        correct: 0 },
                { id: '2aa', sentence: "3x + 15 = 36, x = ?",             options: ["7","6","8"],                        correct: 0 },
                { id: '2bb', sentence: "8x - 32 = 24, x = ?",             options: ["7","6","8"],                        correct: 0 },
                { id: '2cc', sentence: "5x + 10 = 35, x = ?",             options: ["5","4","6"],                        correct: 0 },
                { id: '2dd', sentence: "6x - 12 = 24, x = ?",             options: ["6","5","7"],                        correct: 0 },
                { id: '2ee', sentence: "2x + 22 = 38, x = ?",             options: ["8","7","9"],                        correct: 0 },
                { id: '2ff', sentence: "4x - 20 = 16, x = ?",             options: ["9","8","10"],                       correct: 0 },
                { id: '2gg', sentence: "7x + 28 = 56, x = ?",             options: ["4","3","5"],                        correct: 0 },
                { id: '2hh', sentence: "3x - 18 = 9, x = ?",              options: ["9","8","10"],                       correct: 0 },
                { id: '2ii', sentence: "5x + 20 = 45, x = ?",             options: ["5","4","6"],                        correct: 0 },
                { id: '2jj', sentence: "8x - 24 = 32, x = ?",             options: ["7","6","8"],                        correct: 0 },
                { id: '2kk', sentence: "6x + 18 = 48, x = ?",             options: ["5","4","6"],                        correct: 0 },
                { id: '2ll', sentence: "9x - 36 = 27, x = ?",             options: ["7","6","8"],                        correct: 0 },
                { id: '2mm', sentence: "4x + 16 = 36, x = ?",             options: ["5","4","6"],                        correct: 0 },
                { id: '2nn', sentence: "10x - 30 = 50, x = ?",            options: ["8","7","9"],                        correct: 0 }
              ],

              3: [  // Square roots & powers (Level 4)
                { id: '3a', sentence: "‚àö25 = ?",                          options: ["5","4","6"],                        correct: 0 },
                { id: '3b', sentence: "3¬≤ = ?",                           options: ["9","8","10"],                       correct: 0 },
                { id: '3c', sentence: "‚àö36 = ?",                          options: ["6","5","7"],                        correct: 0 },
                { id: '3d', sentence: "4¬≥ = ?",                           options: ["64","62","66"],                     correct: 0 },
                { id: '3e', sentence: "‚àö49 = ?",                          options: ["7","6","8"],                        correct: 0 },
                { id: '3f', sentence: "5¬≤ = ?",                           options: ["25","24","26"],                     correct: 0 },
                { id: '3g', sentence: "‚àö64 = ?",                          options: ["8","7","9"],                        correct: 0 },
                { id: '3h', sentence: "2‚Åµ = ?",                           options: ["32","30","34"],                     correct: 0 },
                { id: '3i', sentence: "‚àö81 = ?",                          options: ["9","8","10"],                       correct: 0 },
                { id: '3j', sentence: "6¬≤ = ?",                           options: ["36","35","37"],                     correct: 0 },
                { id: '3k', sentence: "‚àö100 = ?",                         options: ["10","9","11"],                      correct: 0 },
                { id: '3l', sentence: "3‚Å¥ = ?",                           options: ["81","80","82"],                     correct: 0 },
                { id: '3m', sentence: "‚àö121 = ?",                         options: ["11","10","12"],                     correct: 0 },
                { id: '3n', sentence: "7¬≤ = ?",                           options: ["49","48","50"],                     correct: 0 },
                { id: '3o', sentence: "‚àö144 = ?",                         options: ["12","11","13"],                     correct: 0 },
                { id: '3p', sentence: "2‚Å∂ = ?",                           options: ["64","62","66"],                     correct: 0 },
                { id: '3q', sentence: "‚àö169 = ?",                         options: ["13","12","14"],                     correct: 0 },
                { id: '3r', sentence: "8¬≤ = ?",                           options: ["64","63","65"],                     correct: 0 },
                { id: '3s', sentence: "‚àö196 = ?",                         options: ["14","13","15"],                     correct: 0 },
                { id: '3t', sentence: "5¬≥ = ?",                           options: ["125","124","126"],                  correct: 0 },
                { id: '3u', sentence: "‚àö225 = ?",                         options: ["15","14","16"],                     correct: 0 },
                { id: '3v', sentence: "9¬≤ = ?",                           options: ["81","80","82"],                     correct: 0 },
                { id: '3w', sentence: "‚àö256 = ?",                         options: ["16","15","17"],                     correct: 0 },
                { id: '3x', sentence: "2‚Å∑ = ?",                           options: ["128","126","130"],                  correct: 0 },
                { id: '3y', sentence: "‚àö289 = ?",                         options: ["17","16","18"],                     correct: 0 },
                { id: '3z', sentence: "10¬≤ = ?",                          options: ["100","99","101"],                   correct: 0 },
                { id: '3aa', sentence: "‚àö324 = ?",                        options: ["18","17","19"],                     correct: 0 },
                { id: '3bb', sentence: "6¬≥ = ?",                          options: ["216","214","218"],                  correct: 0 },
                { id: '3cc', sentence: "‚àö361 = ?",                        options: ["19","18","20"],                     correct: 0 },
                { id: '3dd', sentence: "11¬≤ = ?",                         options: ["121","120","122"],                  correct: 0 },
                { id: '3ee', sentence: "‚àö400 = ?",                        options: ["20","19","21"],                     correct: 0 },
                { id: '3ff', sentence: "2‚Å∏ = ?",                          options: ["256","254","258"],                  correct: 0 },
                { id: '3gg', sentence: "12¬≤ = ?",                         options: ["144","143","145"],                  correct: 0 },
                { id: '3hh', sentence: "‚àö441 = ?",                        options: ["21","20","22"],                     correct: 0 },
                { id: '3ii', sentence: "7¬≥ = ?",                          options: ["343","341","345"],                  correct: 0 },
                { id: '3jj', sentence: "‚àö484 = ?",                        options: ["22","21","23"],                     correct: 0 },
                { id: '3kk', sentence: "13¬≤ = ?",                         options: ["169","168","170"],                  correct: 0 },
                { id: '3ll', sentence: "‚àö529 = ?",                        options: ["23","22","24"],                     correct: 0 },
                { id: '3mm', sentence: "3‚Åµ = ?",                          options: ["243","241","245"],                  correct: 0 },
                { id: '3nn', sentence: "‚àö576 = ?",                        options: ["24","23","25"],                     correct: 0 }
              ],

              4: [  // Advanced operations (Level 5)
                { id: '4a', sentence: "log‚ÇÇ(16) = ?",                     options: ["4","3","5"],                        correct: 0 },
                { id: '4b', sentence: "3^x = 27, x = ?",                   options: ["3","2","4"],                        correct: 0 },
                { id: '4c', sentence: "sin(30¬∞) = ?",                     options: ["0.5","0.6","0.4"],                  correct: 0 },
                { id: '4d', sentence: "‚àõ64 = ?",                          options: ["4","3","5"],                        correct: 0 },
                { id: '4e', sentence: "5! = ?",                           options: ["120","110","130"],                  correct: 0 },
                { id: '4f', sentence: "2^x = 64, x = ?",                   options: ["6","5","7"],                        correct: 0 },
                { id: '4g', sentence: "cos(60¬∞) = ?",                     options: ["0.5","0.6","0.4"],                  correct: 0 },
                { id: '4h', sentence: "log‚ÇÅ‚ÇÄ(1000) = ?",                  options: ["3","2","4"],                        correct: 0 },
                { id: '4i', sentence: "‚àõ125 = ?",                         options: ["5","4","6"],                        correct: 0 },
                { id: '4j', sentence: "4! = ?",                           options: ["24","22","26"],                     correct: 0 },
                { id: '4k', sentence: "tan(45¬∞) = ?",                     options: ["1","0.8","1.2"],                    correct: 0 },
                { id: '4l', sentence: "5^x = 125, x = ?",                  options: ["3","2","4"],                        correct: 0 },
                { id: '4m', sentence: "‚àö(x + 9) = 5, x = ?",              options: ["16","15","17"],                     correct: 0 },
                { id: '4n', sentence: "e^x = e¬≥, x = ?",                   options: ["3","2","4"],                        correct: 0 },
                { id: '4o', sentence: "6! √∑ 4! = ?",                      options: ["30","28","32"],                     correct: 0 },
                { id: '4p', sentence: "‚àõ216 = ?",                         options: ["6","5","7"],                        correct: 0 },
                { id: '4q', sentence: "log‚ÇÉ(81) = ?",                     options: ["4","3","5"],                        correct: 0 },
                { id: '4r', sentence: "sin¬≤(30¬∞) + cos¬≤(30¬∞) = ?",        options: ["1","0.8","1.2"],                    correct: 0 },
                { id: '4s', sentence: "‚àõ(-27) = ?",                       options: ["-3","-2","-4"],                     correct: 0 },
                { id: '4t', sentence: "log‚ÇÇ(32) = ?",                     options: ["5","4","6"],                        correct: 0 },
                { id: '4u', sentence: "4^x = 256, x = ?",                  options: ["4","3","5"],                        correct: 0 },
                { id: '4v', sentence: "sin(90¬∞) = ?",                     options: ["1","0.9","1.1"],                    correct: 0 },
                { id: '4w', sentence: "‚àõ343 = ?",                         options: ["7","6","8"],                        correct: 0 },
                { id: '4x', sentence: "7! √∑ 5! = ?",                      options: ["42","40","44"],                     correct: 0 },
                { id: '4y', sentence: "6^x = 216, x = ?",                  options: ["3","2","4"],                        correct: 0 },
                { id: '4z', sentence: "cos(0¬∞) = ?",                      options: ["1","0.9","1.1"],                    correct: 0 },
                { id: '4aa', sentence: "log‚ÇÅ‚ÇÄ(100) = ?",                  options: ["2","1","3"],                        correct: 0 },
                { id: '4bb', sentence: "‚àõ512 = ?",                        options: ["8","7","9"],                        correct: 0 },
                { id: '4cc', sentence: "3! √ó 2! = ?",                     options: ["12","10","14"],                     correct: 0 },
                { id: '4dd', sentence: "tan(0¬∞) = ?",                     options: ["0","0.1","-0.1"],                   correct: 0 },
                { id: '4ee', sentence: "7^x = 343, x = ?",                 options: ["3","2","4"],                        correct: 0 },
                { id: '4ff', sentence: "sin(60¬∞) = ?",                    options: ["0.866","0.8","0.9"],                correct: 0 },
                { id: '4gg', sentence: "log‚ÇÖ(625) = ?",                   options: ["4","3","5"],                        correct: 0 },
                { id: '4hh', sentence: "‚àõ729 = ?",                        options: ["9","8","10"],                       correct: 0 },
                { id: '4ii', sentence: "8! √∑ 6! = ?",                     options: ["56","54","58"],                     correct: 0 },
                { id: '4jj', sentence: "cos(30¬∞) = ?",                    options: ["0.866","0.8","0.9"],                correct: 0 },
                { id: '4kk', sentence: "9^x = 729, x = ?",                 options: ["3","2","4"],                        correct: 0 },
                { id: '4ll', sentence: "log‚ÇÇ(128) = ?",                   options: ["7","6","8"],                        correct: 0 },
                { id: '4mm', sentence: "‚àõ1000 = ?",                       options: ["10","9","11"],                      correct: 0 },
                { id: '4nn', sentence: "sin(45¬∞) = ?",                    options: ["0.707","0.7","0.75"],               correct: 0 }
              ]
            };

            


            const achievements = {
                "PERFECT_CALCULATOR": { name: "Perfect Calculator", description: "Beat The Calculator without taking damage." },
                "COMBO_KING": { name: "Combo King", description: "Achieve a 20x combo." },
                "LEGENDARY": { name: "Legendary", description: "Complete the Tournament." },
            };

            function clearMechanicTimers() {
              state.mechanicTimers.forEach(id => clearTimeout(id));
              state.mechanicTimers = [];
            }

            // --- GAME STATE ---
            const getInitialState = () => ({
                currentScreen: 'start', score: 0, combo: 0, maxCombo: 0, playerHealth: 100, opponentHealth: 100,
                currentOpponentIndex: 0, currentQuestion: null, timerInterval: null, timeLeft: 10, canAnswer: true,
                wins: 0, perfectWins: 0,
                matchQuestions: [], isEndlessMode: false,
                unlockedMasks: new Set(['üëπ', 'üòà']), earnedAchievements: new Set(),
                playerMask: 'üëπ',
                usedQuestionIds: new Set(),
                mechanicTimers: [],  
            });
            let state = getInitialState();

            // --- GAME LOGIC ---

            function showScreen(screenName) {
                Object.values(screens).forEach(screen => {
                    if (screen) screen.classList.add('hidden');
                });

                const nextScreen = screens[screenName];
                if (nextScreen) {
                    nextScreen.classList.remove('hidden');
                    state.currentScreen = screenName;
                } else {
                    console.error(`Screen "${screenName}" not found.`);
                    return;
                }

                if (screenName === 'start') {
                    document.getElementById('start-button').focus();
                }
            }

            function updateUI() {
                ui.score.textContent = state.score;
                if (state.combo > 1) {
                    ui.comboMeter.textContent = `x${state.combo} COMBO!`;
                    if (ui.comboMeter.style.animationName !== 'comboPop') {
                        ui.comboMeter.style.animation = 'comboPop 0.2s forwards';
                        ui.comboMeter.addEventListener('animationend', () => ui.comboMeter.style.animation = '', { once: true });
                    }
                } else {
                    ui.comboMeter.textContent = '';
                }

                ui.playerStamina.style.width = `${state.playerHealth}%`;
                ui.opponentStamina.style.width = `${state.opponentHealth}%`;
            }

            function startMatch(opponentIndex) {
                clearMechanicTimers();
                state.currentOpponentIndex = opponentIndex;
                const opponent = opponents[opponentIndex];
                
                const healthMultiplier = state.isEndlessMode ? 1 + (state.wins - opponents.length) * 0.1 : 1;

                state.playerHealth = 100;
                state.opponentHealth = opponent.health * healthMultiplier;
                if (!state.isEndlessMode) {
                    state.score = 0;
                }
                state.combo = 0;
                state.matchQuestions  = [...questionsByLevel[opponent.id]].sort(() => Math.random() - 0.5);
                state.usedQuestionIds = new Set();
                ui.opponentName.textContent = opponent.name;
                ui.opponentPortrait.style.backgroundColor = opponent.color1;
                ui.opponentPortrait.textContent = opponent.mask;
                ui.opponentLuchador.querySelector('.luchador-mask').style.backgroundColor = opponent.color1;
                ui.opponentLuchador.querySelector('.luchador-body').style.backgroundColor = opponent.color2;
                ui.opponentLuchador.querySelector('.mask-icon').textContent = opponent.mask;

                updatePlayerAppearance();
                updateUI();
                showScreen('game');
                nextQuestion();
            }

            function nextQuestion() {
                clearMechanicTimers();
                if (state.playerHealth <= 0 || state.opponentHealth <= 0) return;
                if (state.matchQuestions.length === 0) {
                  const pool  = questionsByLevel[opponents[state.currentOpponentIndex].id];
                  const fresh = pool.filter(q => !state.usedQuestionIds.has(q.id));

                  /* all 20 asked?  reset the set and start over */
                  if (fresh.length === 0) {
                    state.usedQuestionIds.clear();
                    state.matchQuestions = [...pool];
                  } else {
                    state.matchQuestions = fresh;
                  }
                  state.matchQuestions.sort(() => Math.random() - 0.5);
                }

                /* Pull the card and mark it as used */
                state.currentQuestion = state.matchQuestions.pop();
                state.usedQuestionIds.add(state.currentQuestion.id);

                state.canAnswer = true;
                ui.questionBox.style.opacity = 1;
                ui.questionBox.style.filter = 'none';
                ui.questionBox.innerHTML = state.currentQuestion.sentence.replace('______', `<span style="color: var(--accent-gold);">______</span>`);
                
                ui.answerButtons.innerHTML = '';
                const shuffledOptions = [...state.currentQuestion.options].sort(() => Math.random() - 0.5);
                
                shuffledOptions.forEach(text => {
                    const button = document.createElement('div');
                    button.classList.add('button', 'answer-button');
                    button.textContent = text;
                    button.tabIndex = 0;
                    button.onclick = () => handleAnswer(text, button);
                    ui.answerButtons.appendChild(button);
                });
                
                const mechanic = opponents[state.currentOpponentIndex].mechanic;
                if (mechanic === 'shuffle' && Math.random() > 0.3) {
                    const opponentSnapshot = state.currentOpponentIndex;           // üëà freeze the match we‚Äôre in

                    const timerId = setTimeout(() => {
                      if (
                           state.currentOpponentIndex !== opponentSnapshot ||
                           !state.canAnswer ||
                           opponents[state.currentOpponentIndex].mechanic !== 'shuffle'
                         ) return;

                        /* Shuffle the visible buttons (Fisher-Yates on the DOM) */
                        const parent = ui.answerButtons;
                        for (let i = parent.children.length - 1; i > 0; i--) {
                            parent.insertBefore(parent.children[i], parent.children[Math.floor(Math.random() * (i + 1))]);
                        }
                    }, 500);
                    state.mechanicTimers.push(timerId);
                }
                if (mechanic === 'fade') {
                    setTimeout(() => ui.questionBox.style.opacity = 0.3, 3000);
                }
                if (mechanic === 'smokescreen' && Math.random() > 0.4) {
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke-overlay';
                    const targetEl = Math.random() > 0.5 ? document.querySelector('.timer-container') : Array.from(ui.answerButtons.querySelectorAll('.answer-button')).filter(b => b.textContent !== state.currentQuestion.options[state.currentQuestion.correct])[0];
                    if(targetEl) {
                        const rect = targetEl.getBoundingClientRect();
                        smoke.style.top = `${rect.top + rect.height / 2 - 75}px`;
                        smoke.style.left = `${rect.left + rect.width / 2 - 75}px`;
                        ui.effectsContainer.appendChild(smoke);
                        setTimeout(() => smoke.remove(), 3000);
                    }
                }
                
                startTimer();
            }

            function startTimer() {
                clearInterval(state.timerInterval);
                
                // Adjust time based on difficulty level
                const baseTime = [24, 30, 40, 50, 60][state.currentOpponentIndex] || 20;
                state.timeLeft = baseTime;
                
                ui.timerBar.style.transition = 'none';
                ui.timerBar.style.width = '100%';

                setTimeout(() => {
                    ui.timerBar.style.transition = `width ${state.timeLeft}s linear`;
                    ui.timerBar.style.width = '0%';
                }, 100);

                state.timerInterval = setInterval(() => {
                    state.timeLeft--;
                    if (state.timeLeft < 0) handleAnswer(null, null);
                }, 1000);
            }

            function handleAnswer(selectedOption, buttonEl) {
                clearMechanicTimers();
                if (!state.canAnswer) return;
                state.canAnswer = false;
                clearInterval(state.timerInterval);

                const correctOption = state.currentQuestion.options[state.currentQuestion.correct];
                const isCorrect = selectedOption === correctOption;

                Array.from(ui.answerButtons.children).forEach(btn => {
                    btn.onclick = null;
                    if (btn.textContent === correctOption) btn.classList.add('correct');
                    else if (btn === buttonEl) btn.classList.add('incorrect');
                    else btn.style.opacity = '0.5';
                });

                if (isCorrect) {
                    const basePoints = 100;
                    const timeBonus = Math.max(0, state.timeLeft * 5);
                    setTimeout(() => handleCorrectAnswer(basePoints, timeBonus), 500);
                } else {
                    setTimeout(handleIncorrectAnswer, 500);
                }
            }

            function handleCorrectAnswer(basePoints, timeBonus) {
                state.combo++;
                if (state.combo > state.maxCombo) state.maxCombo = state.combo;
                
                ui.playerLuchador.style.animation = 'attackLunge 0.2s ease-out forwards';
                ui.playerLuchador.addEventListener('animationend', () => ui.playerLuchador.style.animation = '', { once: true });

                setTimeout(() => startQTE(basePoints, timeBonus), 150);
            }

            function handleIncorrectAnswer() {
                state.combo = 0;
                state.playerHealth = Math.max(0, state.playerHealth - 15);
                
                const feedbackEl = document.createElement('div');
                feedbackEl.id = 'incorrecto-feedback';
                feedbackEl.className = 'feedback-text';
                feedbackEl.innerHTML = `Incorrect!<br><p style="font-size: 0.5em; font-family: var(--font-body); margin: 0;">Keep trying!</p>`;
                ui.effectsContainer.appendChild(feedbackEl);
                setTimeout(() => feedbackEl.remove(), 1500);

                ui.opponentLuchador.style.animation = 'opponentAttackLunge 0.2s ease-out forwards';
                ui.opponentLuchador.addEventListener('animationend', () => ui.opponentLuchador.style.animation = '', { once: true });
                
                setTimeout(() => {
                    gameContainer.style.animation = 'screenShake 0.4s';
                    gameContainer.addEventListener('animationend', () => gameContainer.style.animation = '', { once: true });
                    ui.playerStamina.classList.add('damaged');
                    setTimeout(() => ui.playerStamina.classList.remove('damaged'), 200);
                }, 150);

                updateUI();
                
                setTimeout(() => {
                    checkGameOver();
                    if (state.playerHealth > 0) nextQuestion();
                }, 1500);
            }

            function startQTE(basePoints, timeBonus) {
                ui.qteContainer.classList.remove('hidden');
                const opponentRect = ui.opponentLuchador.getBoundingClientRect();
                ui.qteContainer.style.left = `${opponentRect.left + opponentRect.width / 2 - 60}px`;
                ui.qteContainer.style.top = `${opponentRect.top + opponentRect.height * 0.7 - 60}px`;
                
                const qteCircle = ui.qteTarget.querySelector('#qte-circle');
                qteCircle.style.animation = 'none';
                void qteCircle.offsetWidth;
                qteCircle.style.animation = 'qteShrink 0.6s linear forwards';

                const qteClickHandler = () => {
                    ui.qteTarget.removeEventListener('click', qteClickHandler);
                    handleQTEClick(basePoints, timeBonus);
                };
                ui.qteTarget.addEventListener('click', qteClickHandler);
                
                setTimeout(() => {
                    if (!ui.qteContainer.classList.contains('hidden')) {
                        ui.qteTarget.removeEventListener('click', qteClickHandler);
                        handleQTEClick(basePoints, timeBonus, true);
                    }
                }, 600);
            }

            function handleQTEClick(basePoints, timeBonus, missed = false) {
                const circle = ui.qteTarget.querySelector('#qte-circle');
                const currentScale = circle.getBoundingClientRect().width / ui.qteTarget.getBoundingClientRect().width;
                ui.qteContainer.classList.add('hidden');
                circle.style.animation = 'none';

                let qteBonus = 0;
                let damage = 10;
                let resultText = "Correct!";
                
                const qteResultEl = document.createElement('div');
                qteResultEl.id = 'qte-result';
                qteResultEl.className = 'feedback-text';
                qteResultEl.style.color = '#cccccc';
                
                if (!missed) {
                    if (currentScale < 0.35) { qteBonus = 50; damage = 25; resultText = "Perfect!"; qteResultEl.style.color = 'gold'; } 
                    else if (currentScale < 0.7) { qteBonus = 25; damage = 15; resultText = "Good!"; qteResultEl.style.color = 'lightgreen'; }
                }
                
                const totalPoints = basePoints + timeBonus + qteBonus;
                const comboMultiplier = state.combo > 1 ? state.combo : 1;
                state.score += totalPoints * comboMultiplier;

                state.opponentHealth = Math.max(0, state.opponentHealth - damage);
                
                qteResultEl.textContent = resultText;
                ui.effectsContainer.appendChild(qteResultEl);
                setTimeout(() => qteResultEl.remove(), 1000);
                
                ui.opponentLuchador.style.animation = 'takeDamage 0.5s';
                ui.opponentLuchador.addEventListener('animationend', () => ui.opponentLuchador.style.animation = '', { once: true });
                if(damage > 10) {
                    gameContainer.style.animation = 'screenShake 0.4s';
                    gameContainer.addEventListener('animationend', () => gameContainer.style.animation = '', { once: true });
                }
                
                updateUI();
                
                setTimeout(() => {
                    checkGameOver();
                    if (state.opponentHealth > 0) nextQuestion();
                }, 1000);
            }

            function checkGameOver() {
                if (state.playerHealth <= 0) endGame(false);
                else if (state.opponentHealth <= 0) endGame(true);
            }

            function endGame(playerWon) {
                clearInterval(state.timerInterval);
                ui.rematchButton.style.display = 'none';
                ui.nextMatchButton.style.display = 'none';
                ui.endlessRumbleButton.style.display = 'none';
                
                if (playerWon) {
                    if (state.playerHealth === 100 && !state.isEndlessMode && state.currentOpponentIndex === 0) {
                        state.earnedAchievements.add("PERFECT_CALCULATOR");
                        state.perfectWins++;
                    }
                    if (!state.isEndlessMode) {
                        const defeatedOpponent = opponents[state.currentOpponentIndex];
                        state.unlockedMasks.add(defeatedOpponent.mask);
                    }
                    state.wins++;
                                    ui.gameOverTitle.textContent = "VICTORY!";
                ui.gameOverMessage.textContent = `You defeated ${opponents[state.currentOpponentIndex].name}!`;
                    setTimeout(() => {
                        showGameOverScreen();
                    }, 2000);
                } else {
                                    ui.gameOverTitle.textContent = "DEFEAT!";
                ui.gameOverMessage.textContent = `You were pinned by ${opponents[state.currentOpponentIndex].name}.`;
                    ui.rematchButton.style.display = 'inline-block';
                    showScreen('gameOver');
                }
                checkAchievements();
            }

            function checkAchievements() {
                if (state.maxCombo >= 20) state.earnedAchievements.add("COMBO_KING");
                if (state.currentOpponentIndex >= opponents.length - 1 && state.opponentHealth <= 0 && !state.isEndlessMode) {
                    state.earnedAchievements.add("LEGENDARY");
                }
            }

            function showGameOverScreen() {
                showScreen('gameOver');
                clearMechanicTimers();
                if (state.isEndlessMode) {
                    ui.nextMatchButton.style.display = 'inline-block';
                    ui.nextMatchButton.textContent = 'Next Rumble!';
                } else if (state.currentOpponentIndex < opponents.length - 1) {
                    ui.nextMatchButton.style.display = 'inline-block';
                    ui.nextMatchButton.textContent = 'Next Opponent';
                } else {
                    ui.gameOverTitle.textContent = "CHAMPION!";
                    ui.gameOverMessage.textContent = "You've won the tournament!";
                    ui.endlessRumbleButton.style.display = 'inline-block';
                }
            }
            
            function setupLockerRoom() {
                const nextOpponent = opponents[state.currentOpponentIndex];
                if(nextOpponent) {
                    document.getElementById('next-opponent-name').textContent = nextOpponent.name;
                    document.getElementById('next-opponent-specialty').textContent = nextOpponent.specialty;
                }
                setupCustomization();
                showScreen('lockerRoom');
            }

            // --- EVENT LISTENERS ---
            document.getElementById('start-button').addEventListener('click', () => { state = getInitialState(); setupLockerRoom(); });
            document.getElementById('continue-to-match-button').addEventListener('click', () => startMatch(state.currentOpponentIndex));
            ui.rematchButton.addEventListener('click', () => startMatch(state.currentOpponentIndex));
            ui.nextMatchButton.addEventListener('click', () => { 
                if (state.isEndlessMode) {
                    startMatch(Math.floor(Math.random() * opponents.length));
                } else {
                    state.currentOpponentIndex++; 
                    setupLockerRoom(); 
                }
            });
            ui.endlessRumbleButton.addEventListener('click', () => {
                state.isEndlessMode = true;
                ui.gameOverTitle.textContent = "Endless Rumble";
                ui.gameOverMessage.textContent = `Score: ${state.score}`;
                startMatch(Math.floor(Math.random() * opponents.length));
            });
            ui.mainMenuButton.addEventListener('click', () => { state = getInitialState(); showScreen('start'); });
            
            // Modals
            const openModal = (modal) => { modal.classList.add('active'); modal.querySelector('.button, .swatch')?.focus(); };
            const closeModal = (modal) => modal.classList.remove('active');
            
            document.getElementById('bracket-button').addEventListener('click', () => {
                const list = document.getElementById('bracket-list');
                list.innerHTML = '';
                opponents.forEach((opp, index) => {
                    const li = document.createElement('li');
                    li.className = 'bracket-item';
                    if(index < state.currentOpponentIndex) li.classList.add('defeated');
                    if(index === state.currentOpponentIndex && !state.isEndlessMode) li.classList.add('current');
                    li.innerHTML = `<span>${opp.name}</span> <span>${index < state.currentOpponentIndex ? 'DEFEATED' : 'UPCOMING'}</span>`;
                    list.appendChild(li);
                });
                openModal(modals.bracket);
            });
            document.getElementById('close-bracket-button').addEventListener('click', () => closeModal(modals.bracket));


            
            document.getElementById('stats-button').addEventListener('click', () => {
                document.getElementById('stats-wins').textContent = state.wins;
                document.getElementById('stats-perfect').textContent = state.perfectWins;
                document.getElementById('stats-combo').textContent = state.maxCombo;
                const achList = document.getElementById('achievement-list');
                achList.innerHTML = '';
                if(state.earnedAchievements.size === 0) achList.innerHTML = '<li>None yet!</li>';
                else state.earnedAchievements.forEach(achId => achList.insertAdjacentHTML('beforeend', `<li>${achievements[achId].name}: ${achievements[achId].description}</li>`));
                openModal(modals.stats);
            });
            document.getElementById('close-stats-button').addEventListener('click', () => closeModal(modals.stats));



            // Customization
            function updatePlayerAppearance() {
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--player-color-primary');
                const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--player-color-secondary');
                ui.playerPortrait.style.backgroundColor = primaryColor;
                ui.playerPortrait.textContent = state.playerMask;
                ui.playerLuchador.querySelector('.luchador-mask').style.backgroundColor = primaryColor;
                ui.playerLuchador.querySelector('.mask-icon').textContent = state.playerMask;
                ui.playerLuchador.querySelector('.luchador-body').style.backgroundColor = secondaryColor;
            }

            function setupCustomization() {
                const colors = {
                    primary: { "Lucha Blue":'#0d6efd', "Danger Red":'#dc3545', "Verde Victorioso":'#198754', "Purple Pain":'#6f42c1', "Orange Fury":'#fd7e14', "Minty Fresh":'#20c997' },
                    secondary: { "Gold Standard":'#ffc107', "Steel Gray":'#6c757d', "Cyber Cyan":'#0dcaf0', "Power Pink":'#d63384', "Cloudy Day":'#f8f9fa', "Metal Silver":'#adb5bd' }
                };
                
                const createSwatches = (containerId, items, isColor, property) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    Object.entries(items).forEach(([name, value]) => {
                        const swatch = document.createElement('div');
                        swatch.className = 'swatch';
                        swatch.tabIndex = 0;
                        swatch.title = name;
                        if(isColor) swatch.style.backgroundColor = value;
                        else swatch.textContent = value;
                        
                        swatch.addEventListener('click', () => {
                            if (isColor) document.documentElement.style.setProperty(property, value);
                            else state.playerMask = value;
                            container.querySelector('.selected')?.classList.remove('selected');
                            swatch.classList.add('selected');
                            updatePlayerAppearance();
                        });
                        container.appendChild(swatch);
                    });
                };

                createSwatches('primary-swatches', colors.primary, true, '--player-color-primary');
                createSwatches('secondary-swatches', colors.secondary, true, '--player-color-secondary');
                createSwatches('mask-swatches', Object.fromEntries(Array.from(state.unlockedMasks).map(m => [m, m])), false);
                
                document.querySelector('#primary-swatches .swatch').classList.add('selected');
                document.querySelector('#secondary-swatches .swatch').classList.add('selected');
                const selectedMask = Array.from(document.querySelectorAll('#mask-swatches .swatch')).find(s => s.textContent === state.playerMask);
                if (selectedMask) selectedMask.classList.add('selected'); else document.querySelector('#mask-swatches .swatch').classList.add('selected');

                updatePlayerAppearance();
            }
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    if (document.activeElement && typeof document.activeElement.click === 'function') {
                        e.preventDefault();
                        document.activeElement.click();
                    }
                }

                if (state.currentScreen === 'game') {
                    if (e.code === 'Space' && !ui.qteContainer.classList.contains('hidden')) {
                        ui.qteTarget.click();
                    }
                    if (!state.canAnswer) return;
                    const answerButtons = Array.from(ui.answerButtons.querySelectorAll('.answer-button'));
                    if (e.key >= '1' && e.key <= '3') {
                        const button = answerButtons[parseInt(e.key) - 1];
                        if (button && button.style.display !== 'none') button.click();
                    }
                }
            });

            // --- INITIALIZATION ---
            function init() {
                showScreen('start');
            }

            init();
        });
    </script>
</body>
</html>
